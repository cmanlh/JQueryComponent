"use strict";!function(g){$JqcLoader.importComponents("com.lifeonwalden.jqc",["baseElement","valHooks","uniqueKey","pinyin"]).importCss($JqcLoader.getCmpParentURL("com.lifeonwalden.jqc","selectbox").concat("css/selectbox.css")).execute(function(){var o=new Map,d="";function S(t,e,o){if(t.has(e)){var i=t.get(e);g.isArray(i)?i.push(o):t.set(e,[i,o])}else t.set(e,o)}var e={source:null,extOption:null,supportPinYin:!1,pinyinParser:null,supportFuzzyMatch:!1,maxOptionCount:10};function i(t){if(this.option=g.extend(!0,{},e,t),this.source=null,this.optionMapping=new Map,this.sortedFilterCache=[],this.filterIndex=new Map,this.optionsCache=new Map,this.undefinedOption='<li class="none" value="'.concat(d).concat('">无对应选项</li>'),this.option.supportPinYin&&(!this.option.pinyinParser||!this.option.pinyinParser.firstAlphabet))throw new Error("Need a pinyin parser that supports firstAlphabet.")}function b(t,e,o,i,n,a){e!=t&&(S(o,e,i),n.push(e));var l=a.option.pinyinParser.firstAlphabet(e);t!=l&&e!=l&&(S(o,l,i),n.push(l))}i.prototype.get=function(t){return this.optionMapping.get(t)},i.prototype.fetchLabel=function(t){var e=this.get(t);return e?e.text:void 0},i.prototype.fuzzyFilter=function(t){var e=null;if(0==(e=t.isMulti?g.trim(t.value):g.trim(t)).length)return this.undefinedOption;if(-1==(a=this.optionsCache.get(e)))return this.undefinedOption;var o="",i=this.sortedFilterCache.length;if(!t.isMulti&&a)return a;for(var n=0,a=!1,l=new Map,r=0;r<i;r++){var s=this.sortedFilterCache[r];if(0<=s.filter.indexOf(e)){if(a=!0,g.isArray(s.data)){var c=s.data;for(var p in c){var u=c[p],d=u.data[u.key];t.isMulti&&t.selected.has(d)||(l.has(d)||(l.set(d,null),o=o.concat(u.label),n++))}}else{d=(c=s.data).data[c.key];if(t.isMulti&&t.selected.has(d))continue;if(l.has(d))continue;l.set(d,null),o=o.concat(c.label),n++}if(this.option.maxOptionCount==n)break}}return a?(t.isMulti?this.optionsCache.set(e,1):this.optionsCache.set(e,o),o):(this.optionsCache.set(e,-1),this.undefinedOption)},i.prototype.filter=function(t){var e=null;if(0==(e=t.isMulti?g.trim(t.value):g.trim(t)).length)return this.undefinedOption;var o=this.optionsCache.get(e);if(-1==o)return this.undefinedOption;if(!t.isMulti&&o)return o;var i=this.filterIndex.get(e);if(-1==i)return this.undefinedOption;var n="",a=i,l=-1,r=this.sortedFilterCache.length;if(null==i||null==i){var s=e.length;do{if(s--,-1==(i=this.filterIndex.get(e.substring(0,s))))return this.filterIndex.set(e,-1),this.undefinedOption;if(0<=i){a=i;break}a=0}while(0<=s)}for(var c=0,p=new Map,u=a;u<r;u++){var d=this.sortedFilterCache[u];if(d.filter.substr(0,e.length)===e){if(-1==l&&(l=u),g.isArray(d.data)){var h=d.data;for(var f in h){var v=h[f],C=v.data[v.key];t.isMulti&&t.selected.has(C)||(p.has(C)||(p.set(C,null),n=n.concat(v.label),c++))}}else{C=(h=d.data).data[h.key];if(t.isMulti&&t.selected.has(C))continue;if(p.has(C))continue;p.set(C,null),n=n.concat(h.label),c++}if(this.option.maxOptionCount==c)break}else if(-1<l)break}return-1<l?(this.filterIndex.set(e,l),t.isMulti?this.optionsCache.set(e,1):this.optionsCache.set(e,n),n):(this.filterIndex.set(e,-1),this.optionsCache.set(e,-1),this.undefinedOption)},i.prototype.updateDataSource=function(t){this.option.source.adapter?this.option.source.data=t:this.option.source=t,this.optionMapping=new Map,this.sortedFilterCache=[],this.filterIndex=new Map,this.optionsCache=new Map,this.setup()},i.prototype.addNewItem=function(t){var e=null;(e=this.option.source.adapter?this.option.source.data:this.option.source).push(t),this.updateDataSource(e)},i.prototype.setup=function(){var t=this.option.source;if(!t)throw new Error("The data source of selectbox should not be null or undefined.");var e="value",o="filter",i="pinyinFilter",n="label",a=new Map,l=[],r=null;if(g.isArray(t))t[0][o]||(o=n),t[0][i]||(i=o),r=t;else{if(t.adapter){if(t.adapter.value&&(e=t.adapter.value),t.adapter.label&&(n=t.adapter.label),t.adapter.filter)o=t.adapter.filter;else{if("string"!=typeof n)throw new Error("Must provide a field for filtering.");o=n}i=t.adapter.pinyinFilter?t.adapter.pinyinFilter:o}r=t.data}for(var s in this.option.extOption&&(r=g.isArray(this.option.extOption)?r.concat(this.option.extOption):r.push(this.option.extOption)),r){var c=r[s];if(c&&null!=c[e]){var p=null;if("string"==typeof n){if(null==c[n])continue;if(this.optionMapping.has(c[e].toString()))continue;p={label:"<li ".concat('value="v').concat(c[e]).concat('" title="').concat(c[n]).concat('">').concat(c[n]).concat("</li>"),key:e,text:c[n],data:c}}else{var u=n(c);p={label:"<li ".concat('value="v').concat(c[e]).concat('" title="').concat(u).concat('">').concat(u).concat("</li>"),key:e,text:u,data:c}}var d=c[o].toString();if(S(a,d,p),l.push(d),this.option.supportPinYin)if("string"==typeof i)b(d,h=c[i].toString(),a,p,l,this);else if(this.option.supportFuzzyMatch){var h="";for(var f in i)h=h.concat(c[i[f]].toString());b(d,h,a,p,l,this)}else for(var f in i){b(d,h=c[i[f]].toString(),a,p,l,this)}this.optionMapping.set(c[e].toString(),p)}}var v=l.sort(),C=null;for(var s in v){var y=v[s];y!=C&&(C=y,this.sortedFilterCache.push({filter:y,data:a.get(y)}))}};var n={dataName:null,optionData:null,extOption:null,width:120,defaultVal:null,supportPinYin:!(i.prototype.autoDisplay=function(o){var i=[];if(this.sortedFilterCache.length){for(var n="",a=0,t=0;t<this.sortedFilterCache.length;t++){var e=this.sortedFilterCache[t].data;if(g.isArray(e))e.forEach(function(t){var e=t.data[t.key];o&&o.currentVal==e||o&&o.selected&&o.selected.has(e)||-1<i.indexOf(e)||(i.push(e),n+=t.label,a++)});else{var l=e.data[e.key];if(o&&o.currentVal==l)continue;if(null!=o&&o.selected&&o.selected.has(l))continue;if(-1<i.indexOf(l))continue;i.push(l),n+=e.label,a++}if(10<=a)break}return n}return this.undefinedOption}),pinyinParser:null,supportMultiSelect:!1,element:null,supportFuzzyMatch:!1,filterDelay:256,withSearch:!0,withResetter:!0,onSelect:null,afterSelect:null,updateDataSource:null,postClear:null,addNewItem:null,maxOptionCount:10};g.jqcSelectBox=function(t){if(0<arguments.length&&g.jqcBaseElement.apply(this,arguments),this.options=g.extend(!0,{},n,t),!this.options.dataName)throw new Error("Must provide a unique data name to identify the same type select box");if(!this.options.element)throw new Error("Must Binding SelectBox to a text input element.");this.optionCore=o.get(this.options.dataName),this.optionCore||(this.optionCore=new i({source:this.options.optionData,extOption:this.options.extOption,supportPinYin:this.options.supportPinYin,pinyinParser:this.options.pinyinParser,supportFuzzyMatch:this.options.supportFuzzyMatch,maxOptionCount:this.options.maxOptionCount}),this.optionCore.setup(),o.set(this.options.dataName,this.optionCore)),this.el=this.options.element,this.el.addClass("jqcSelectboxHooks");var e=this.el.outerWidth();this.el.css("background-position",e-26),this.options.withSearch||this.el.addClass("onlySelect").prop("readonly",!0).css("background-position",e-21),this.typeName="jqcSelectBox",this.elementId="jqc".concat(g.jqcUniqueKey.fetchIntradayKey()),this.el.attr(g.jqcBaseElement.JQC_ELEMENT_TYPE,this.typeName),this.el.attr(g.jqcBaseElement.JQC_ELEMENT_ID,this.elementId),g.jqcValHooksCtrl.addElement(this),this.options.defaultVal||0===this.options.defaultVal||!1===this.options.defaultVal?this.defaultVal=this.options.defaultVal.toString():this.defaultVal=d,this.options.supportMultiSelect?function(n){n.container=g('<div class="jqcSelectboxContainer" style="display:none;">'),n.operationBar=g('<div class="jqcSelectboxOperationBar">'),n.input=g('<input placeholder="输入选项值">').addClass("search-input"),n.resetter=g('<button class="jqcSelectboxResetter" title="清空当前所选项">重置</button>'),n.refresher=g('<button class="jqcSelectboxRefresher" title="从服务器获取新选项">刷新</button>'),n.addNewItem=g('<button class="jqcSelectboxAddNewItem" title="从服务器获取新选项">新增</button>'),n.optionUL=g('<ul class="jqcSelectboxOptions">'),n.optionSelected=g('<ul class="jqcSelectboxSelectedOption"></ul>'),n.operationBar.append(n.input),n.options.withResetter&&n.operationBar.append(n.resetter);n.options.updateDataSource&&n.operationBar.append(n.refresher);n.options.addNewItem&&n.operationBar.append(n.addNewItem);n.container.append(n.operationBar).append(n.optionUL).append(n.optionGap).append(n.optionSelected);var i=n.el.outerHeight(),a=n.el.outerWidth();n.container.css("width",2*a),n.input.css("width",a),n.optionUL.css("width",a),n.optionSelected.css("width",a),n.container.appendTo("body"),n.valueCache=new Map,n.defaultVal!==d&&n.defaultVal&&0<n.defaultVal.length&&n.defaultVal.split(",").forEach(function(t){n.valueCache.set(t,null)});var l=0,r=!1;n.el.focus(function(t){l=1;var e=n.el.offset(),o=g("body").width();n.container.css("top",e.top+i+4),n.container.outerWidth()+e.left+5>o?n.container.css("right",o-(e.left+a)):n.container.css("left",e.left),g(this).addClass("jqcSelectboxHooks-active"),n.container.show(),n.input.focus(),n.options.autoDisplay&&n.optionUL.html(n.optionCore.autoDisplay({selected:n.valueCache}))});var o=null,s=n.options.supportFuzzyMatch?n.optionCore.fuzzyFilter:n.optionCore.filter,c=null,p=null,u=0;function e(t){c=null,n.input.val(""),n.optionUL.empty(),n.optionSelected.empty(),n.valueCache.clear(),n.el.val(n.defaultVal),t&&(n.container.hide(),n.el.removeClass("jqcSelectboxHooks-active").trigger("blur")),n.el.trigger("change",n.defaultVal)}n.input.keydown(function(t){switch(t.keyCode){case g.ui.keyCode.TAB:return n.container.hide(),n.el.removeClass("jqcSelectboxHooks-active").trigger("blur"),n.el.nextAll(":input").first().focus(),void t.preventDefault()}}),n.input.keyup(function(t){switch(t.keyCode){case g.ui.keyCode.ENTER:n.optionUL.find("li.jqcSelectboxSelected").trigger("click");break;case g.ui.keyCode.ESCAPE:return l=4,void g(document).trigger("click");case g.ui.keyCode.UP:null==p?p=-1:p--;break;case g.ui.keyCode.DOWN:null==p?p=0:p++;break;default:var e=n.input.val();return""==g.trim(e)&&n.options.autoDisplay?void n.optionUL.html(n.optionCore.autoDisplay({selected:n.valueCache})):(null!=o&&clearTimeout(o),void(o=setTimeout(function(){c!=n.input.val()&&(n.optionUL.html(s.call(n.optionCore,{value:n.input.val(),selected:n.valueCache,isMulti:!0})),p=null),o=null,c=n.input.val()},n.filterDelay)))}0!==(u=n.optionUL.find("li").length)&&(n.optionUL.find("li.jqcSelectboxSelected").removeClass("jqcSelectboxSelected"),n.optionUL.find("li").eq(p%=u).addClass("jqcSelectboxSelected"))}),g(document).click(function(t){if(1!==l&&2!==l&&(n.container.hide(),n.el.removeClass("jqcSelectboxHooks-active").trigger("blur"),r&&n.options.afterSelect)){r=!1;var o=[];n.currentVal.split(",").forEach(function(t){var e=n.optionCore.get(t);e&&o.push(e.data)}),n.options.afterSelect(o)}l=3}),n.container.click(function(t){l=2}),n.optionUL.on("click","li",function(t){var e=g(t.target),o=e.attr("value");if(null!=o&&null!=o&&d!=o&&(o=o.substr(1),!n.valueCache.has(o))){if(n.currentVal?n.el.val(n.currentVal.concat(",").concat(o)):n.el.val(o),n.options.onSelect){var i=[];n.currentVal.split(",").forEach(function(t){var e=n.optionCore.get(t);e&&i.push(e.data)}),n.options.onSelect(i,n.optionCore.get(o).data,!0)}n.input.val(""),n.input.focus(),n.valueCache.set(o,null),e.remove(),r=!0}}),n.optionSelected.on("click","li",function(t){var e=g(t.target).attr("value");if(null!=e&&null!=e){e=e.substr(1),n.valueCache.delete(e);var o="",i=[];n.valueCache.forEach(function(t,e){n.options.onSelect&&i.push(n.optionCore.get(e).data),o=o.concat(",").concat(e)}),0===o.length?n.el.val(d):n.el.val(o.substr(1)),n.options.onSelect&&n.options.onSelect(i,n.optionCore.get(e).data,!1),n.optionUL.append(n.optionCore.get(e).label),r=!0}}),n.options.withResetter&&n.resetter.click(function(t){e(!0),n.options.postClear&&n.options.postClear()});n.options.updateDataSource&&n.refresher.click(function(t){n.options.updateDataSource&&n.options.updateDataSource(function(t){g.isArray(t)&&n.optionCore.updateDataSource(t),e(!1)})});n.options.addNewItem&&n.addNewItem.click(function(t){n.container.hide(),n.el.removeClass("jqcSelectboxHooks-active").trigger("blur"),n.options.addNewItem(function(t){t&&n.optionCore.addNewItem(t)})})}(this):function(i){i.container=g('<div class="jqcSelectboxContainer" style="display:none;">'),i.operationBar=g('<div class="jqcSelectboxOperationBar">'),i.input=g('<input placeholder="输入选项值">').addClass("search-input"),i.resetter=g('<button class="jqcSelectboxResetter" title="清空当前所选项">重置</button>'),i.refresher=g('<button class="jqcSelectboxRefresher" title="从服务器获取新选项">刷新</button>'),i.addNewItem=g('<button class="jqcSelectboxAddNewItem" title="从服务器获取新选项">新增</button>'),i.optionUL=g("<ul>");var t=i.el.outerWidth(),e=t;i.options.withSearch?(i.operationBar.append(i.input),i.options.withResetter&&(e+=54,i.operationBar.append(i.resetter)),i.options.updateDataSource&&(i.operationBar.append(i.refresher),e+=54),i.options.addNewItem&&(i.operationBar.append(i.addNewItem),e+=54),i.container.append(i.operationBar).append(i.optionUL)):i.container.append(i.optionUL);var n=i.el.outerHeight(),a=i.el.outerWidth();i.container.css("width",e),i.input.css("width",t),i.container.appendTo("body");var l=!1;i.el.focus(function(t){l=!0;var e=i.el.offset(),o=g("body").width();i.container.css("top",e.top+n+4),i.container.outerWidth()+e.left+5>o?i.container.css("right",o-(e.left+a-15)):i.container.css("left",e.left),g(this).addClass("jqcSelectboxHooks-active"),i.container.show(),i.input.focus(),i.options.autoDisplay&&i.optionUL.html(i.optionCore.autoDisplay({currentVal:i.currentVal}))});var o=null,r=i.options.supportFuzzyMatch?i.optionCore.fuzzyFilter:i.optionCore.filter,s=null,c=null,p=0;function u(t){s=null,i.input.val(""),i.optionUL.empty(),i.el.val(i.defaultVal),t&&(i.container.hide(),i.el.removeClass("jqcSelectboxHooks-active").trigger("blur")),i.el.trigger("change",i.defaultVal)}i.input.keydown(function(t){switch(t.keyCode){case g.ui.keyCode.TAB:return i.container.hide(),i.el.removeClass("jqcSelectboxHooks-active").trigger("blur"),i.el.nextAll(":input").first().focus(),void t.preventDefault()}}),i.input.keyup(function(t){switch(t.keyCode){case g.ui.keyCode.ENTER:return i.optionUL.find("li.jqcSelectboxSelected").trigger("click"),void(c=null);case g.ui.keyCode.ESCAPE:return i.container.hide(),void i.el.removeClass("jqcSelectboxHooks-active").trigger("blur");case g.ui.keyCode.UP:null==c?c=-1:c--;break;case g.ui.keyCode.DOWN:null==c?c=0:c++;break;default:var e=i.input.val();return""==g.trim(e)&&i.options.autoDisplay?void i.optionUL.html(i.optionCore.autoDisplay({currentVal:i.currentVal})):(null!=o&&clearTimeout(o),void(o=setTimeout(function(){s!=i.input.val()&&(i.optionUL.html(r.call(i.optionCore,i.input.val())),c=null),o=null,s=i.input.val()},i.filterDelay)))}0!==(p=i.optionUL.find("li").length)&&(i.optionUL.find("li.jqcSelectboxSelected").removeClass("jqcSelectboxSelected"),i.optionUL.find("li").eq(c%=p).addClass("jqcSelectboxSelected"))}),g(document).click(function(t){i.container.is(":hidden")||(l||(i.container.hide(),i.el.removeClass("jqcSelectboxHooks-active").trigger("blur")),l=!1)}),i.container.click(function(t){l=!0}),i.optionUL.on("click","li",function(t){var e=g(t.target).attr("value");null!=e&&null!=e&&d!=e&&(e=e.substr(1),i.options.onSelect&&i.options.onSelect(i.optionCore.get(e).data),i.options.afterSelect&&i.options.afterSelect(i.optionCore.get(e).data),i.input.val(""),i.optionUL.empty(),i.el.val(e),s=null,i.container.hide(),i.el.removeClass("jqcSelectboxHooks-active").trigger("blur"))}),i.options.withResetter&&i.resetter.click(function(t){u(!0),i.options.postClear&&i.options.postClear()});i.options.updateDataSource&&i.refresher.click(function(t){i.options.updateDataSource&&i.options.updateDataSource(function(t){g.isArray(t)&&i.optionCore.updateDataSource(t),u(!1)})});i.options.addNewItem&&i.addNewItem.click(function(t){i.container.hide(),i.el.removeClass("jqcSelectboxHooks-active").trigger("blur"),i.options.addNewItem(function(t){t&&i.optionCore.addNewItem(t)})})}(this),this.el.val(this.defaultVal)},g.jqcSelectBox.prototype=new g.jqcBaseElement,g.jqcSelectBox.prototype.constructor=g.jqcSelectBox,g.jqcSelectBox.prototype.updateCurrentVal=function(t){if(this.currentVal=t,this.options.supportMultiSelect){if(this.currentVal===d)return this.optionSelected.empty(),"";var o="",i="",n=this;return this.currentVal.split(",").forEach(function(t){var e=n.optionCore.get(t);e&&(i=i.concat(e.label),o=o.concat(",").concat(e.text),n.valueCache.set(t,null))}),this.optionSelected.html(i),o.substr(1)}if(this.currentVal===d)return"";var e=this.optionCore.get(this.currentVal);return e?e.text:""},g.jqcSelectBox.prototype.updateDataSource=function(t){g.isArray(t)&&this.optionCore.updateDataSource(t)};var t=g.jqcSelectBox.prototype.destroy;g.jqcSelectBox.prototype.destroy=function(){t.apply(this),this.el.removeClass("jqcSelectboxHooks").removeClass("jqcSelectboxHooks-active").off("focus").off("blur"),this.container.remove()}})}(jQuery);