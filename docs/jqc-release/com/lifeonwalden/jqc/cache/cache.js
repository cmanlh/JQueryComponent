"use strict";!function(f){$JqcLoader.importComponents("com.lifeonwalden.jqc",["dateUtil"]).execute(function(){var e=new Map,a={name:null,init:{immediate:!1,data:null,url:null,param:null,parseFun:null,replaceWithNew:!1},localstorage:{delay:1e3,expiryTime:!1,refreshUrl:null,parseFun:null,primaryKey:null,enable:!1}},i={key:null,notNeedFullRemoteData:!0,patch:{enable:!1,url:null,parseFun:null,param:null}},c="jqcCacheDatabase",p="__expiryTimestamp__",u=1,o=2;function s(a,n,o,t){var e=a.options.init.data;if(f.isArray(e))return a.data=e,a.cacheStatus=u,void(n&&n(a.data));a.options.localstorage.enable&&!t?indexedDB.open(c).onsuccess=function(t){var e=t.target.result;e.objectStoreNames.contains(a.options.name)?e.transaction(a.options.name,"readonly").objectStore(a.options.name).getAll().onsuccess=function(t){var e=t.target.result;0<e.length?(a.data=e,a.cacheStatus=u,n&&n(a.data),function(a){if(!a.options.localstorage.expiryTime||!a.options.localstorage.refreshUrl)return;var t=a.data,n=[];for(var e in t){var o=t[e],i=o[p];if(!(i&&i>Date.now())){var s={};s[a.options.localstorage.primaryKey]=o[a.options.localstorage.primaryKey],f.ajax({url:a.options.localstorage.refreshUrl,method:"GET",data:s,async:!1,success:function(t){if(a.options.localstorage.parseFun){var e=a.options.localstorage.parseFun(t);e&&n.push(e)}else t&&n.push(t)}})}}h(a.options.name,a.options.localstorage.primaryKey,n)}(a)):l(a,n,o)}:l(a,n,o)}:l(a,n,o)}function r(t){this.map=new Map,this.options=t}function l(e,a,t){if(t)return e.cacheStatus=o,e.data=[],void(a&&a(e.data));if(0<f.trim(e.options.init.url).length){var n={url:e.options.init.url,method:"GET",async:!1,success:function(t){e.options.init.parseFun?e.data=e.options.init.parseFun(t):e.data=t,e.cacheStatus=u,a&&a(e.data),e.options.localstorage.enable&&setTimeout(function(){h(e.options.name,e.options.localstorage.primaryKey,e.data)},e.options.localstorage.delay)}};e.options.init.param&&(n=f.extend(!0,n,{data:e.init.param})),f.ajax(n)}}function h(n,o,i,s){var r=indexedDB.open(c);r.onsuccess=function(t){var e=t.target.result;if(e.objectStoreNames.contains(n))d(e,n,i,s);else{var a=e.version;e.close(),(r=indexedDB.open(c,parseInt(a)+1)).onupgradeneeded=function(t){(e=t.target.result).createObjectStore(n,{keyPath:o}).transaction.oncomplete=function(t){d(e,n,i,s)}}}}}function d(t,e,a,n){var o=0;"string"==typeof n&&(o=f.jqcDateUtil.plus(new Date,n,!0));var i=t.transaction(e,"readwrite");if(f.isArray(a)){var s=i.objectStore(e);if(0<o)for(var r in a){var l=a[r];l[p]=o,s.put(l)}else for(var r in a)s.put(a[r])}else 0<o&&(a[p]=o),a&&i.objectStore(e).put(a)}f.jqcCache=function(t){if(this.options=f.extend(!0,{},a,t),this.data=[],(this.cacheStatus=0)==f.trim(this.options.name).length)throw new Error("cache name cann't be null");if(e.has(this.options.name))return e.get(this.options.name);e.set(this.options.name,0),this.options.init.immediate&&s(this,null,null,this.options.init.replaceWithNew)},f.jqcCache.prototype.build=function(t,e){var a=f.extend(!0,{},i,t,{context:this}),n=null;n="string"==typeof a.key?function(t,e,a){for(var n in t){var o=t[n];e.set(o[a],o)}}:function(t,e,a){for(var n in t){var o=t[n];e.set(a(o),o)}};var o=new r(a);return this.isInitialled()?(n(this.data,o,a.key),o):e?void s(this,function(t){n(t,o,a.key),e&&e()},a.notNeedFullRemoteData,this.options.init.replaceWithNew):(s(this,null,a.notNeedFullRemoteData,this.options.init.replaceWithNew),o)},f.jqcCache.prototype.isInitialled=function(){return this.cacheStatus===u},f.jqcCache.prototype.queryAll=function(t){if(this.isInitialled())return t&&t(this.data),this.data;if(null==t||null==t)throw new Error("has to provide call back function");s(this,t,!1,this.options.init.replaceWithNew)},f.jqcCache.prototype.refreshDB=function(t){s(this,t,!1,!0)},r.prototype.get=function(a,n){if(0==f.trim(a).length)return n?void n(null):null;var o=this;if(o.map.has(a))return n?void n(o.map.get(a)):o.map.get(a);var i,s,r,t,l=o.options.context;if(!n){if(o.options.patch.enable){var e=null;return f.ajax({url:o.options.patch.url,method:"GET",data:o.options.patch.param(a),async:!1,success:function(t){e=o.options.patch.parseFun?o.options.patch.parseFun(t):t,l.data.push(e),o.map.set(a,e),l.options.localstorage.enable&&l.cacheStatus===u&&setTimeout(function(){h(l.options.name,l.options.localstorage.primaryKey,e)},l.options.localstorage.delay)}}),e}return null}i=l.name,s=a,r=function(t){if(t)l.data.push(t),o.map.set(a,t),n(t);else if(o.options.patch.enable){var e=null;f.ajax({url:o.options.patch.url,method:"GET",data:o.options.patch.param(a),async:!1,success:function(t){e=o.options.patch.parseFun?o.options.patch.parseFun(t):t,l.data.push(e),o.map.set(a,e),l.options.localstorage.enable&&l.cacheStatus===u&&setTimeout(function(){h(l.options.name,l.options.localstorage.primaryKey,e)},l.options.localstorage.delay)}}),n(e)}else n(null)},(t=indexedDB.open(c)).onsuccess=function(t){var e=t.target.result;e.objectStoreNames.contains(i)?e.transaction(i).objectStore(i).get(s).onsuccess=function(t){r(t.target.result)}:r(null)},t.onerror=function(t){r(null)}},r.prototype.set=function(t,e){this.map.set(t,e)}})}(jQuery);